# 3. post processing
**"No fix? Why don't you reduce the number of satellites? "**

---

## PPK analysis with L1-DGNSS and RTKLIB

### Analysis Flowchart

**Analysis (Indoor Work)**
1. download the UBX file from the Base/Rover receiver
    - When using uBlox receivers
2. convert UBX to RINEX file with RTKCONV
    - RINEX ver. 3.02 is used to match the Control Station.
3. find the coordinates of Rover by RTKPOST
    - Static mode is used as the positioning mode when measuring a fixed position.
    - If the coordinates of Base are unknown: Rover's coordinates are relative
    - If the coordinates of Base are known: Rover's coordinates are absolute values
4. obtain the coordinates of Rover
    - See the text file of the analysis results (.pos)
    - In the case of a Fix solution: Coordinates of the last row with Ratio = 999.9
    - For a Float solution: the coordinates of the row with the highest Ratio

**preparation (to be downloaded)**
1. [RTKLIB](https://github.com/tomojitakasu/ RTKLIB) (a set of analysis software such as RTKCONV and RTKPOST, the latest version of which is rtklib 2.4.2 p13). 
2. [GSIGEO2011](http://www.gsi.go.jp/ buturisokuchi/geoid_model.html) (geoid model)
    - The latest version is "Japanese Gioid 2011" (Version 2), but in RTKLIB 2.4.2, not supported in all areas of Japan (some areas may not work properly)

### basic glossary

![img](./pic/1.png)

## Preparation

### Download RTKLIB
The latest source code  
[https://github.com/tomojitakasu](https:// github.com/tomojitakasu)
  - Reading the source code makes sense of features that aren't in the manual (sometimes).
  - Currently, the latest version is being developed and released on github

The latest binaries (non-developers, click here)
[https://github.com/tomojitakasu/RTKLIB_bin ](https://github.com/tomojitakasu/RTKLIB_ bin)
  - Use binaries (exe files) if you want to use it with Windows GUI
  - Download the entire bin folder

## Checking the operation of RTKLIB
**If RTKLIB doesn't work**.  
A common phenomenon in workshops and other events.

- Clicking Execute can't process it or causes an error  
→ "Run as administrator"

- Processing is started, but no file is produced.  
→ Change the version to download.

- I just can't process it (it doesn't work properly).  
-> Get a copy of the binary file of someone which is working properly.

## Download GSIGEO2011
- [Latest version of "Japanese Geoid 2011" (Version 2)] (http://www.gsi. go.jp/buturisokuchi/geoid_model.html
)    
  RTKLIB 2.4.2 does not support the latest geoid models (in some areas it does not work properly) 

- [GSI, "Geoid Height Calculatior"](https://vldb.gsi.go.jp/) sokuchi/surveycalc/geoid/calcgh/calcframe. html)  
RTKLIB can be calculated with ellipsoidal height while the geoid height can be found on this website

- GSI [“Japanese Fundamental Geospatial Data Download Service"](https://fgd.gsi. go.jp/download/menu.php
)  
  - File used: gsigeo2011_ver2.asc
  - RTKLIB 2.4.2 does not support the latest geoid models (in some areas it does not work properly)

![img](./pic/2.png)

## Download observation data

### Downloading Data from Base/Rover Receivers
**Download the UBX file**.
- Examples of EMLID Reach RS / Reach RTK
- Connect the receiver via Wi-Fi and download the data

![img](./pic/3.png)

## RINEX conversion

### Converting UBX to RINEX files with RTKCONV
- RINEX ver. 3.02 is used to match the GNSS-based Control Station.
- RTKLIB uses data in RINEX format  
- Native files (.ubx) are stored in Reach RS / Reach RTK by u-blox 
- RTKCONV is a tool for converting native files from various companies to RINEX
  - Some manufacturers' observational data cannot be converted (file specifications are not available).
- By using the asterisk "*" in the source file name, you can convert multiple contiguous but segmented files into a single RINEX file.
If you specify the start and end date and time, you can also output a RINEX file for the period of time (to make the operation lighter).

**RTKCONV（RTKLIB/bin/rtkconv.exe）**

![img](./pic/4.png)

![img](./pic/5.png)

![img](./pic/6.png)

## PPK Analysis - The basic procedure of analysis is shown with an example of not using absolute coordinates of Base

### Find the coordinates of Rover with RTKPOST
**RTKPOST (RTKLIB/bin/rtkpost.exe)**
- rtkpost.exe: This is the most commonly used one
- rtkpost_mkl.exe: if the Intel® Mass Kernel Library is available

! [img](. /pic/7.png)

- Only when you use RTKPOST for the first time, do the following first
1. change the "Positioning Mode" on the Options screen to "Static".
  - Static: To observe a fixed location
  - Kinematic: The case of observing a moving object
2. Click "OK" to close the Options screen.

![img](./pic/8.png)

- Set up Base/Rover observation data (RINEX file)
- Note the fields for setting each file in Base/Rover
- If you don't set "Static" on the Options screen, you can't set the Base file.

![img](./pic/9.png)

Options “Setting1”

![img](./pic/10.png)

Options “Setting2”

![img](./pic/11.png)

Options “Output”

![img](./pic/12.png)

Options “Positions”

![img](./pic/13.png)

Options “Stats”, “Files”, “Misc”
- All defaults
- Make sure that what should be left blank is left blank.

![img](./pic/14.png)

1. Have you set up Base/Rover observation data (RINEX file)?
2. Have you checked that all tabs in the Options are set up properly?
- Options remembers previous settings, so you need to check them **every time you analyze them**.

![img](./pic/15.png)

**【参考1】Roverの「標高」を出力する：RTKPOSTにGSIGEO2011を設定する**

1. “Options”を開いて
2. “Files”タブの”Geoid Data File”にgsigeo2011_ver2.ascを指定（左図）
3. “Output”タブの”Datum / Height”で”Geodetic”を指定（右図）
4. 同タブの”Geoid Model”で“GSI2000 (1x1.5”）“を指定（右図）
- RTKLIB 2.4.2は最新のジオイドモデルに対応していない（正常動作しない地域がある）

![img](./pic/16.png)

**【参考2】電子基準点データの使用：RTKPOSTに座標とPCV補正ファイルを設定する**

1. “Options”を開いて
2. “Files”タブの”Receiver Antenna PCV File”にGSI_PCV.pcv（または.TXT）を指定（左図）
  - 受信機のアンテナファイルは2行目に指定する。 1行目は衛星のアンテナファイルを指定する欄
3. “Positions”タブの”Base Station”に電子基準点の座標＋楕円体高を入力（右図）
4. 同タブのBase Stationの”Antenna Type”に「 * 」（自動選択）を入力（右図）

![img](./pic/17.png)

**【参考3】Baseの絶対座標の使用：RTKPOSTにBase座標を設定する**

1. “Options”を開いて
2. “Positions”タブの”Base Station”にBaseの絶対座標＋楕円体高を入力
  - dmsで入力する場合、度分秒の数値を半角スペースで区切る
3. 同タブのBase Stationの”Antenna Type”のチェックを外す
  - PPK解析では、Baseアンテナ位相中心の位置からRoverまでの基線ベクトルを求めるため、Baseのアンテナ高の入力は不要。入力すると「アンテナを設置した地面」の高さを意味する。そこじゃない。

![img](./pic/18.png)

## 成果出力

### Roverの座標を出力する
- 解析結果（.pos）のテキストファイルを参照
- Fix解の場合：Ratio = 999.9となった最終行の座標
- Float解の場合：Ratioが最も高い行の座標

![img](./pic/19.png)

## ノウハウ
**【解説1】RTKPLOT**
- GNSS観測データ（.obs）と解析結果（.pos）を図化するソフトウェア
- 観測データの図化：受信衛星の数と品質（高度、SNR、マルチパス）の評価
- 解析結果の図化：解の品質（Grd Trk, Position, AR）の評価

![img](./pic/20.png)

**GNSS観測データ（.obs）の図化：BaseとRover両方の観測データについて評価する**

- 受信衛星の数と品質（高度、SNR、マルチパス）の評価
- 左の例は全体的にSNRが低く（35dbHz以下）、Fix解は得られないかもしれない
- 右の例は受信状態が良いが、G20, J01のSNRが低く、解析から除外したほうが良いかもしれない

![img](./pic/21.png)

**解析結果の図化（.pos）の図化**

- 解の品質（Grd Trk, Position, AR）の評価
- 下の図は同じ解析結果を図化したもの。観測期間の全エポックでFix解が得られている
- 左はPosition図。E-W, N-S, U-D（XYZ）各軸の位置の変動を見る。いずれも±5 mm以内であり、良好
- 中はGrd Trk図。マスの目盛は1 mm。グレーの円はエラーサークルで、時間の経過とともに小さくなっている。南北8 mm、東西5 mmの範囲にすべての解が収まっている
- 右の図はRatio Factor for AR Validation図。Ratio Factorの最大値は1,000。解析期間中のほとんどのエポックで1,000を示し、変動も少ない。安定した測位解が得られている

![img](./pic/22.png)

- 解の品質（Grd Trk, Position, AR）の評価
- 下の図は同じ解析結果を図化したもの。観測期間の前半がFloat、後半がFix解となった
- 左はPosition図。Float解（オレンジ色）の水平方向は1 m、垂直方向は4 mの変動がみられる
- 中はGrd Trk図。マスの目盛は20 cm。エラーサークルは時間の経過とともに小さくなり、Float解は南北1.6 m、東西1 mの範囲に収まる。Fix解は中央左下の1点に収束している
- 右の図はRatio Factor for AR Validation図。Ratio Factorはゆっくりと上昇するが、最大値の1,000に達した後は安定している

![img](./pic/23.png)

**【解説2】L1-DGNSS測量と解析のポイント**

- **計画**
  - 同じ測位衛星システム内で5つ以上の衛星を、良いSNRで受信が継続できること
  - 受信環境が最も良好で安定した場所にBaseを配置する。建物の屋上がベスト。車の屋根の上も可
  - Baseの周辺は立ち入り禁止。サイクルスリップや振動による精度劣化が生じる
  - 基線長を小さくする（Baseを観測領域の中央に置く）
  - 雨天や濃霧など、BaseとRoverの上空の大気状態が異なると誤差も増加する（二重差による誤差要因の相殺ができない）。基線長のZ方向の差が大きい場合も同様。長期観測ではそうした影響も考慮し、気象データを用いた対流圏遅延補正を行う必要がある（中島・他、2018）
- **測量**
  - アンテナ高は2 m以上とする（人間や植生による電波遮蔽の低減）
  - Roverは過酷な自然環境の中でも丁寧に作業できる人が担当する
設置精度を最大限に高める（NG：石突の位置ズレ、ポールの傾き、計測中の揺れ）
  - 揺れは厳禁（地球は自転し、公転し、衛星も地球を周回する。計測中の僅かの揺れでも悪影響がある）
  - 高さのあるものから可能な限り離れて計測する（電波遮蔽軽減）
アンテナを直接、地面に置いて計測しない（電波遮蔽の元凶）
- **解析**
  - 低高度でもSNRが高い場合は解析に使用する
  - 植生の葉っぱは電波を通すが、SNRを低下させる
  - SNRが低い、SNRが低い状態で安定しない、サイクルスリップがある衛星は除外する
  - 観測期間の途中で登場する衛星は、除外したほうが良い場合もある（ARがリセットされる）
  - パラメータをいじって無理やりFixさせない（衛星の除外を除き全Roverを同じ条件で解析する）
